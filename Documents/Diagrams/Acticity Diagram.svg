<svg width="700" height="1150" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#333" />
    </marker>
  </defs>

  <!-- Background -->
  <rect x="0" y="0" width="700" height="1150" fill="white" />

  <!-- Start Node -->
  <circle cx="350" cy="40" r="15" fill="black" />
  <text x="380" y="45" font-family="Arial" font-size="14">Start Level</text>
  <line x1="350" y1="55" x2="350" y2="90" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <!-- === STAGE 1: WARM UP === -->
  <rect x="150" y="90" width="400" height="230" rx="10" fill="#f0f8ff" stroke="#4682b4" stroke-dasharray="5,5" />
  <text x="160" y="110" font-family="Arial" font-size="12" fill="#4682b4" font-weight="bold">Stage 1: Vocabulary Acquisition</text>

  <rect x="250" y="130" width="200" height="40" rx="5" fill="white" stroke="#333" stroke-width="2" />
  <text x="350" y="155" font-family="Arial" font-size="12" text-anchor="middle">Display Vocab Bubbles</text>

  <line x1="350" y1="170" x2="350" y2="200" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <rect x="250" y="200" width="200" height="40" rx="5" fill="white" stroke="#333" stroke-width="2" />
  <text x="350" y="215" font-family="Arial" font-size="12" text-anchor="middle">User Speaks Word</text>
  <text x="350" y="230" font-family="Arial" font-size="10" fill="gray" text-anchor="middle">(Transliterator available)</text>

  <line x1="350" y1="240" x2="350" y2="270" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <polygon points="350,270 420,300 350,330 280,300" fill="#fffacd" stroke="#333" stroke-width="2" />
  <text x="350" y="295" font-family="Arial" font-size="11" text-anchor="middle">Pronunciation</text>
  <text x="350" y="310" font-family="Arial" font-size="11" text-anchor="middle">Correct?</text>

  <!-- Loop back Stage 1 -->
  <line x1="280" y1="300" x2="230" y2="300" stroke="#333" stroke-width="2" />
  <line x1="230" y1="300" x2="230" y2="220" stroke="#333" stroke-width="2" />
  <line x1="230" y1="220" x2="250" y2="220" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />
  <text x="240" y="290" font-family="Arial" font-size="11">No</text>

  <!-- Arrow to Stage 2 -->
  <line x1="350" y1="330" x2="350" y2="370" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />
  <text x="360" y="350" font-family="Arial" font-size="11">Yes</text>

  <!-- === STAGE 2: SENTENCES === -->
  <rect x="150" y="370" width="400" height="180" rx="10" fill="#f0fff0" stroke="#2e8b57" stroke-dasharray="5,5" />
  <text x="160" y="390" font-family="Arial" font-size="12" fill="#2e8b57" font-weight="bold">Stage 2: Sentence Building</text>

  <rect x="250" y="410" width="200" height="40" rx="5" fill="white" stroke="#333" stroke-width="2" />
  <text x="350" y="435" font-family="Arial" font-size="12" text-anchor="middle">Select Missing Words</text>

  <line x1="350" y1="450" x2="350" y2="480" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <rect x="250" y="480" width="200" height="40" rx="5" fill="white" stroke="#333" stroke-width="2" />
  <text x="350" y="505" font-family="Arial" font-size="12" text-anchor="middle">Speak Full Sentence</text>

  <line x1="350" y1="520" x2="350" y2="570" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <!-- === STAGE 3: NPC SIMULATION === -->
  <rect x="100" y="570" width="500" height="400" rx="10" fill="#fff0f5" stroke="#cd5c5c" stroke-dasharray="5,5" />
  <!-- Fixed: Replaced "&" with "&amp;" -->
  <text x="110" y="590" font-family="Arial" font-size="12" fill="#cd5c5c" font-weight="bold">Stage 3: NPC Simulation &amp; Fallback</text>

  <rect x="250" y="610" width="200" height="40" rx="5" fill="white" stroke="#333" stroke-width="2" />
  <text x="350" y="635" font-family="Arial" font-size="12" text-anchor="middle">NPC Asks Question</text>

  <line x1="350" y1="650" x2="350" y2="680" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <rect x="250" y="680" width="200" height="40" rx="5" fill="white" stroke="#333" stroke-width="2" />
  <text x="350" y="705" font-family="Arial" font-size="12" text-anchor="middle">User Speaks Answer</text>

  <line x1="350" y1="720" x2="350" y2="750" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <!-- Voice Check Diamond -->
  <polygon points="350,750 420,780 350,810 280,780" fill="#fffacd" stroke="#333" stroke-width="2" />
  <text x="350" y="775" font-family="Arial" font-size="11" text-anchor="middle">Voice</text>
  <text x="350" y="790" font-family="Arial" font-size="11" text-anchor="middle">Recognized?</text>

  <!-- YES Path -->
  <line x1="350" y1="810" x2="350" y2="920" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />
  <text x="360" y="830" font-family="Arial" font-size="11" fill="green" font-weight="bold">Yes</text>

  <!-- NO Path -->
  <line x1="420" y1="780" x2="470" y2="780" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />
  <text x="425" y="770" font-family="Arial" font-size="11" fill="red">No</text>

  <!-- Error Check Diamond -->
  <polygon points="520,780 570,805 520,830 470,805" fill="#e6e6fa" stroke="#333" stroke-width="2" />
  <text x="520" y="800" font-family="Arial" font-size="10" text-anchor="middle">Errors</text>
  <text x="520" y="815" font-family="Arial" font-size="10" text-anchor="middle">>= 3?</text>

  <!-- Loop Back (Errors < 3) -->
  <line x1="520" y1="780" x2="520" y2="700" stroke="#333" stroke-width="2" />
  <line x1="520" y1="700" x2="450" y2="700" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />
  <text x="525" y="740" font-family="Arial" font-size="11">No (Retry)</text>

  <!-- Fallback (Errors >= 3) -->
  <line x1="520" y1="830" x2="520" y2="860" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />
  <text x="525" y="845" font-family="Arial" font-size="11" fill="red">Yes</text>

  <rect x="460" y="860" width="120" height="40" rx="5" fill="#ffe4e1" stroke="#333" stroke-width="2" />
  <text x="520" y="885" font-family="Arial" font-size="11" text-anchor="middle">Use Bypass</text>

  <line x1="520" y1="900" x2="520" y2="940" stroke="#333" stroke-width="2" />
  <line x1="520" y1="940" x2="450" y2="940" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <!-- Success Action -->
  <rect x="250" y="920" width="200" height="40" rx="5" fill="#90ee90" stroke="#333" stroke-width="2" />
  <text x="350" y="945" font-family="Arial" font-size="12" text-anchor="middle">NPC Happy / Success</text>

  <line x1="350" y1="960" x2="350" y2="1000" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <!-- === STAGE 4: SUMMARY === -->
  <rect x="150" y="1000" width="400" height="80" rx="10" fill="#ffffe0" stroke="#ffd700" stroke-dasharray="5,5" />
  <text x="160" y="1020" font-family="Arial" font-size="12" fill="#daa520" font-weight="bold">Stage 4: Summary</text>

  <rect x="250" y="1030" width="200" height="40" rx="5" fill="white" stroke="#333" stroke-width="2" />
  <!-- Fixed: Replaced "&" with "&amp;" -->
  <text x="350" y="1055" font-family="Arial" font-size="12" text-anchor="middle">Calculate XP &amp; Badge</text>

  <line x1="350" y1="1070" x2="350" y2="1100" stroke="#333" stroke-width="2" marker-end="url(#arrow)" />

  <!-- End Node -->
  <circle cx="350" cy="1115" r="15" fill="none" stroke="black" stroke-width="4" />
  <circle cx="350" cy="1115" r="8" fill="black" />
  <text x="390" y="1120" font-family="Arial" font-size="14">End Level</text>

</svg>